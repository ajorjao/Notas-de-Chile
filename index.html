<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<link rel="stylesheet" type="text/css" href="style.css" media="screen" />

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>
<body>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

	<script src="d3.v3.min.js"></script>
	<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
	<script src="d3.geo.tile.v0.min.js"></script>
	<!-- <script src="http://d3js.org/d3.geo.tile.v0.min.js"></script> -->
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="d3.tip.js"></script>

	<script>

/////////////////// Parametros ////////////////////////
filtros = {
	"zoom": "Region", 
	// "zoom": "Comuna", 

	"Dependencia_Colegio": null, 
	// "Dependencia_Colegio": "Municipal", 
	// "Dependencia_Colegio": "Particular Subvencionado", 
	// "Dependencia_Colegio": "Particular Pagado", 
	// "Dependencia_Colegio": "Corporacion de Administracion Delegada", 

	"Ruralidad": null, 
	// "Ruralidad": "Rural", 
	// "Ruralidad": "Urbano", 

	"Agno": null,
	// "Agno": "2013",
	// "Agno": "2014",
	// "Agno": "2015",
	// "Agno": "2016",
	// "Agno": "2017",

	"Coordenadas_Paralelas": {
		"N_Colegios": {"min": null, "max": null},
		"Asistencia_Promedio": {"min": null, "max": null},
		"Promedio_Notas": {"min": null, "max": null},
		"Promedio_Mujeres": {"min": null, "max": null},
		"Promedio_Hombres": {"min": null, "max": null}
	}
};
///////////////////////////////////////////////////////


///////////////////////////////////////////////////////
//   FUNCIONES UTILES PARA COLOREO Y SELECCION DATOS
///////////////////////////////////////////////////////

	function rescale_cant_colegios(val, max, min, mult){ //el mayor sera "mult" veces mas grande que el menor
		return (mult-1)/(max-min)*val + 1 - (mult-1)*(min/(max-min)) //similar a usar escalamiento logaritmico pero con mayor control
	}

	function get_discetized_color(nota){
		// deltas = (max_promedio_nota - min_promedio_nota)/discretizacion
		deltas = (max_nota["selected_promedio"] - min_nota["selected_promedio"])/discretizacion

		pend_discretizada_color = 255/discretizacion

		// alpha = parseInt(round(round(nota - min_promedio_nota, 6) / round(deltas, 6), 4))
		alpha = parseInt(round(round(nota - min_nota["selected_promedio"], 6) / round(deltas, 6), 4))

		bueno = pend_discretizada_color*alpha
		malo = pend_discretizada_color*(discretizacion - alpha)

		// return d3.rgb(0,bueno,malo) // rojo, verde, azul
		return d3.rgb(malo,0,bueno) // rojo, verde, azul
	}

	function componentToHex(c) {
		var hex = c.toString(16);
		return hex.length == 1 ? "0" + hex : hex;
	}

	function rgbToHex(r, g, b) {
			return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
	}

	function hexToR(h) {return parseInt((cutHex(h)).substring(0,2),16)}
	function hexToG(h) {return parseInt((cutHex(h)).substring(2,4),16)}
	function hexToB(h) {return parseInt((cutHex(h)).substring(4,6),16)}
	function cutHex(h) {return (h.charAt(0)=="#") ? h.substring(1,7):h}

	function round(x, decimales){
		return Math.round(x*10**decimales)/10**decimales
	}

	function actualizar_data(map=true, coord=true){

		if (coord){ // si se actualizan las coordenadas paralelas, se deben reiniciar filtros porq sino quedan como "seleccionados" sin poder quitarse
			filtros["Coordenadas_Paralelas"] = {
				"N_Colegios": {"min": null, "max": null},
				"Asistencia_Promedio": {"min": null, "max": null},
				"Promedio_Notas": {"min": null, "max": null},
				"Promedio_Mujeres": {"min": null, "max": null},
				"Promedio_Hombres": {"min": null, "max": null}
			}
		}
		bounds = getScreenBounds();
		max_nota["selected_promedio"] = 0
		min_nota["selected_promedio"] = 7
		max_nota["selected_total"] = 0
		min_nota["selected_total"] = 7
		selected_data = []
		for (var i = 0; i < data.length; i++) {
			this_zone = data[i];
			if (this_zone.Latitude > bounds["Latitude"]["Min"] && this_zone.Latitude < bounds["Latitude"]["Max"]){
				if (this_zone.Longitude > bounds["Longitude"]["Min"] && this_zone.Longitude < bounds["Longitude"]["Max"]){

					// Object.keys(filtros["Coordenadas_Paralelas"]).forEach(function(d){
					// 	// console.log(d)
					// 	if (filtros["Coordenadas_Paralelas"][d]["max"] != null && filtros["Coordenadas_Paralelas"][d]["min"] != null){
					// 		if (this_zone > filtros["Coordenadas_Paralelas"][d]["max"] || this_zone < filtros["Coordenadas_Paralelas"][d]["min"]){ //si tiene problemas con el filtro, se salta el objeto
					// 			continue //no se puede usar un continue dentro de un forEach
					// 		}
					// 	}
					// })

					if (filtros["Coordenadas_Paralelas"]["N_Colegios"]["max"] != null && filtros["Coordenadas_Paralelas"]["N_Colegios"]["min"] != null){
						if (this_zone.N_Colegios > filtros["Coordenadas_Paralelas"]["N_Colegios"]["max"] || this_zone.N_Colegios < filtros["Coordenadas_Paralelas"]["N_Colegios"]["min"]){ //si tiene problemas con el filtro, se salta el objeto
							continue
						}
					}
					if (filtros["Coordenadas_Paralelas"]["Asistencia_Promedio"]["max"] != null && filtros["Coordenadas_Paralelas"]["Asistencia_Promedio"]["min"] != null){
						if (this_zone.Asistencia_Promedio > filtros["Coordenadas_Paralelas"]["Asistencia_Promedio"]["max"] || this_zone.Asistencia_Promedio < filtros["Coordenadas_Paralelas"]["Asistencia_Promedio"]["min"]){ //si tiene problemas con el filtro, se salta el objeto
							continue
						}
					}
					if (filtros["Coordenadas_Paralelas"]["Promedio_Notas"]["max"] != null && filtros["Coordenadas_Paralelas"]["Promedio_Notas"]["min"] != null){
						if (this_zone.Promedio_Notas > filtros["Coordenadas_Paralelas"]["Promedio_Notas"]["max"] || this_zone.Promedio_Notas < filtros["Coordenadas_Paralelas"]["Promedio_Notas"]["min"]){ //si tiene problemas con el filtro, se salta el objeto
							continue
						}
					}
					if (filtros["Coordenadas_Paralelas"]["Promedio_Mujeres"]["max"] != null && filtros["Coordenadas_Paralelas"]["Promedio_Mujeres"]["min"] != null){
						if (this_zone.Promedio_Mujeres > filtros["Coordenadas_Paralelas"]["Promedio_Mujeres"]["max"] || this_zone.Promedio_Mujeres < filtros["Coordenadas_Paralelas"]["Promedio_Mujeres"]["min"]){ //si tiene problemas con el filtro, se salta el objeto
							continue
						}
					}
					if (filtros["Coordenadas_Paralelas"]["Promedio_Hombres"]["max"] != null && filtros["Coordenadas_Paralelas"]["Promedio_Hombres"]["min"] != null){
						if (this_zone.Promedio_Hombres > filtros["Coordenadas_Paralelas"]["Promedio_Hombres"]["max"] || this_zone.Promedio_Hombres < filtros["Coordenadas_Paralelas"]["Promedio_Hombres"]["min"]){ //si tiene problemas con el filtro, se salta el objeto
							continue
						}
					}

					selected_data.push(data[i]);

					max_nota["selected_promedio"] = data[i].Promedio_Notas > max_nota["selected_promedio"] ? data[i].Promedio_Notas : max_nota["selected_promedio"]
					min_nota["selected_promedio"] = data[i].Promedio_Notas < min_nota["selected_promedio"] ? data[i].Promedio_Notas : min_nota["selected_promedio"]

					max_nota["selected_total"] = data[i].Promedio_Hombres > max_nota["selected_total"] ? data[i].Promedio_Hombres : max_nota["selected_total"]
					min_nota["selected_total"] = data[i].Promedio_Hombres < min_nota["selected_total"] ? data[i].Promedio_Hombres : min_nota["selected_total"]

					max_nota["selected_total"] = data[i].Promedio_Mujeres > max_nota["selected_total"] ? data[i].Promedio_Mujeres : max_nota["selected_total"]
					min_nota["selected_total"] = data[i].Promedio_Mujeres < min_nota["selected_total"] ? data[i].Promedio_Mujeres : min_nota["selected_total"]
				} 
			}
		}
		// console.log(selected_data)
		if (map){
			// console.log("actualiced map")
			clearMap();
			createMap(selected_data);
		}
		if (coord){
			// console.log("actualiced coord")
			clearCoordParalelas();
			createCoordParalelas(selected_data);
		}
		/*if (bars){
			clearBars();
			createBars(selected_data);
		}*/

		$("#loader").hide();
		// console.log("data actualizada")

		window.clearTimeout(actualizar_visualizaciones);
	}


///////////////////////////////////////////////////////
//     VARIABLES GLOBALES PARA MANEJO DE DATOS
///////////////////////////////////////////////////////

	var width = Math.max(960, window.innerWidth),
		height = Math.max(500, window.innerHeight),
		prefix = prefixMatch(["webkit", "ms", "Moz", "O"]);
		
	color_regiones = {"Arica y Parinacota": "#d98880", //ordenadas de norte a sur
			"Tarapaca": "#f1948a", 
			"Antofagasta": "#c39bd3", 
			"Atacama": "#bb8fce", 
			"Coquimbo": "#7fb3d5", 
			"Valparaiso": "#85c1e9",
			"Metropolitana": "#76d7c4",
			"Gral Bernardo OHiggins": "#73c6b6",
			"Maule": "#7dcea0", 
			"Biobio": "#82e0aa", 
			"Araucania": "#f7dc6f", 
			"Los Rios": "#f8c471",  
			"Los Lagos": "#f0b27a",
			"Aysen": "#e59866",
			"Magallanes": "#bfc9ca"}


	var map_width = width*0.395; //el mapa usara un 35% del ancho de la pantalla
	var coord_width = width*0.595; //el grafico de coordenadas paralelas usara un 65% del ancho de la pantalla
	var coord_height = height*0.45;

	var data_regiones = [];
	var data_comunas = [];
	var selected_data = [];
	var actualizar_visualizaciones // cronometro para que los mapas se actualicen despues de 1 segundo de dejar de mover el zoom

	var max_nota_comuna = 2;
	var min_nota_comuna = 7;
	var max_nota_region = 2;
	var min_nota_region = 7;
	// var max_promedio_nota = 0;
	// var min_promedio_nota = 0;
	//en max_nota y min_nota, total es para mujeres, hombres y promedios (usado en coord paralalelas) //selected_promedio es para recalcular los maximos y minimos promedio (mapa) //selected_total es para tener el maximo y minimo de tanto hombres y mujeres mezclados (coord paralelas)
	var max_nota = {"promedio_region": 0, "mujer_region": 0, "hombre_region": 0, "total_region": 0, "promedio_comuna": 0, "mujer_comuna": 0, "hombre_comuna": 0, "total_comuna": 0, "selected_promedio": 0, "selected_total": 0} 
	var min_nota = {"promedio_region": 7, "mujer_region": 7, "hombre_region": 7, "total_region": 7, "promedio_comuna": 7, "mujer_comuna": 7, "hombre_comuna": 7, "total_comuna": 7, "selected_promedio": 7, "selected_total": 0}
	var max_cant_colegios_comuna = 0;
	var min_cant_colegios_comuna = 3000;
	var max_cant_colegios_region = 0;
	var min_cant_colegios_region = 3000;
	var discretizacion = 5; //cuantos colores distintos para diferenciar en la leyenda
	var promedio_data = {};


///////////////////////////////////////////////////////
//          MANEJO DE DATOS DEL CSV
///////////////////////////////////////////////////////
	function read_dataset(new_filter=null, value=null){
		$("#loader").show()

		if (new_filter && value){
			value = (value == "null") ? null : value
			filtros[new_filter] = value

		}
		d3.csv("Rendimiento_por_cursos_georeferenciados3.csv", type, function(error, dataset) { 
			if (error) throw error;

			let nombre_region;
			let region;
			let nombre_comuna;
			let comuna;

			let promedio_nota;

			data_regiones = [];
			data_comunas = [];


			// se buscan los datos maximos y minimos de n_colegios y promedios
			// ademas se guarda la data en data_regiones y data_comunas (se guarda Nombre, N_Colegios, Promedio_Notas, Longitude, Latitude)
			for (var i = 0; i < Object.keys(promedio_data).length; i++) {
				nombre_region = Object.keys(promedio_data)[i]
				region = promedio_data[nombre_region]

				promedio_mujeres = (region.Suma_Nota_Mujeres/region.N_Cursos_Mujeres);
				promedio_hombres = (region.Suma_Nota_Hombres/region.N_Cursos_Hombres);
				promedio_nota = (region.Suma_Nota_Promedio/region.N_Cursos);
				asistencia_promedio = (region.Suma_Asistencia_Promedio/region.N_Cursos);
				// edad_promedio = (region.Suma_Edad_Promedio/region.N_Cursos);

				cant_colegios = region.N_Colegios;
				// if (promedio_nota > max_nota_region) {max_nota_region = promedio_nota};
				// if (promedio_nota < min_nota_region) {min_nota_region = promedio_nota};
				if (promedio_nota > max_nota["promedio_region"]) {max_nota["promedio_region"] = promedio_nota};
				if (promedio_nota < min_nota["promedio_region"]) {min_nota["promedio_region"] = promedio_nota};
				if (promedio_mujeres > max_nota["mujer_region"]) {max_nota["mujer_region"] = promedio_mujeres};
				if (promedio_mujeres < min_nota["mujer_region"]) {min_nota["mujer_region"] = promedio_mujeres};
				if (promedio_hombres > max_nota["hombre_region"]) {max_nota["hombre_region"] = promedio_hombres};
				if (promedio_hombres < min_nota["hombre_region"]) {min_nota["hombre_region"] = promedio_hombres};
				if (Math.max(promedio_nota, promedio_mujeres, promedio_hombres) > max_nota["total_region"]){
					max_nota["total_region"] = Math.max(promedio_nota, promedio_mujeres, promedio_hombres)
				};
				if (Math.min(promedio_nota, promedio_mujeres, promedio_hombres) < min_nota["total_region"]){
					min_nota["total_region"] = Math.min(promedio_nota, promedio_mujeres, promedio_hombres)
				};
				if (promedio_nota < min_nota["total_region"]) {min_nota["total_region"] = promedio_nota};
				if (cant_colegios > max_cant_colegios_region) {max_cant_colegios_region = cant_colegios};
				if (cant_colegios < min_cant_colegios_region) {min_cant_colegios_region = cant_colegios};
				data_regiones.push({
					Nombre: nombre_region, 
					N_Colegios: region.N_Colegios, 
					Promedio_Notas: promedio_nota, 
					Promedio_Mujeres: promedio_mujeres, 
					Promedio_Hombres: promedio_hombres, 
					Asistencia_Promedio: asistencia_promedio,
					// Edad_Promedio: edad_promedio,
					Longitude: +region.Longitude, 
					Latitude: +region.Latitude, 
				})
				for (var j = 0; j < Object.keys(region.comunas).length; j++) {
					nombre_comuna = Object.keys(region.comunas)[j];
					comuna = region.comunas[nombre_comuna];

					promedio_mujeres = (comuna.Suma_Nota_Mujeres/comuna.N_Cursos_Mujeres);
					promedio_hombres = (comuna.Suma_Nota_Hombres/comuna.N_Cursos_Hombres);
					promedio_nota = (comuna.Suma_Nota_Promedio/comuna.N_Cursos);
					asistencia_promedio = (comuna.Suma_Asistencia_Promedio/comuna.N_Cursos);
					edad_promedio = (comuna.Suma_Edad_Promedio/comuna.N_Cursos);

					cant_colegios = comuna.N_Colegios;
					// if (promedio_nota > max_nota_comuna) {max_nota_comuna = promedio_nota};
					// if (promedio_nota < min_nota_comuna) {min_nota_comuna = promedio_nota};
					if (promedio_nota > max_nota["promedio_comuna"]) {max_nota["promedio_comuna"] = promedio_nota};
					if (promedio_nota < min_nota["promedio_comuna"]) {min_nota["promedio_comuna"] = promedio_nota};
					if (promedio_mujeres > max_nota["mujer_comuna"]) {max_nota["mujer_comuna"] = promedio_mujeres};
					if (promedio_mujeres < min_nota["mujer_comuna"]) {min_nota["mujer_comuna"] = promedio_mujeres};
					if (promedio_hombres > max_nota["hombre_comuna"]) {max_nota["hombre_comuna"] = promedio_hombres};
					if (promedio_hombres < min_nota["hombre_comuna"]) {min_nota["hombre_comuna"] = promedio_hombres};
					if (Math.max(promedio_nota, promedio_mujeres, promedio_hombres) > max_nota["total_comuna"]){
						max_nota["total_comuna"] = Math.max(promedio_nota, promedio_mujeres, promedio_hombres)
					};
					if (Math.min(promedio_nota, promedio_mujeres, promedio_hombres) < min_nota["total_comuna"]){
						min_nota["total_comuna"] = Math.min(promedio_nota, promedio_mujeres, promedio_hombres)
					};
					if (cant_colegios > max_cant_colegios_comuna) {max_cant_colegios_comuna = cant_colegios};
					if (cant_colegios < min_cant_colegios_comuna) {min_cant_colegios_comuna = cant_colegios};
					data_comunas.push({
						Nombre: nombre_comuna, 
						Region: nombre_region,
						N_Colegios: comuna.N_Colegios, 
						Promedio_Notas: promedio_nota, 
						Promedio_Mujeres: promedio_mujeres, 
						Promedio_Hombres: promedio_hombres, 
						Asistencia_Promedio: asistencia_promedio,
						Edad_Promedio: edad_promedio,
						Longitude: +comuna.Longitude, 
						Latitude: +comuna.Latitude
					})
				}
				// }
			}

			// max_nota["selected_promedio"] = max_nota["promedio_region"];
			// min_nota["selected_promedio"] = min_nota["promedio_region"];
			// createMap(data_regiones)

			// createCoordParalelas(data_regiones)

			// console.log("charged")
			$("#loader").hide()
			
			if (filtros.zoom == "Region"){
				data = data_regiones
			}
			else{
				data = data_comunas
			}
			actualizar_data()
		});
	}

	read_dataset() //llamada inicial

	// recopilacion de datos y se guardan en "promedio_data", por cada fila del csv se ejecuta el siguiente codigo
	function type(d) {
		if (filtros.Dependencia_Colegio != null && filtros.Dependencia_Colegio != d.Dependencia_Colegio) {
			return null;
		}

		if (filtros.Ruralidad != null && filtros.Ruralidad != d.Ruralidad) {
			return null;
		}

		if (filtros.Agno != null && filtros.Agno != d.Agno) {
			return null;
		}

		d.Nivel_Educacion = d.Nivel_Educacion.replace(/a$/,"o") // para decir en vez de 1_Basica -> 1_Basico

		if (d.Region_Colegio in promedio_data){ //si existía la reguion
			//se suma la nota del colegio actual a la ponderacion de la region
			promedio_data[d.Region_Colegio].Suma_Nota_Promedio += +d.Nota_Promedio;
			promedio_data[d.Region_Colegio].Suma_Nota_Mujeres += +d.Nota_Mujeres;
			promedio_data[d.Region_Colegio].Suma_Nota_Hombres += +d.Nota_Hombres;
			promedio_data[d.Region_Colegio].Suma_Asistencia_Promedio += +d.Asistencia_Promedio;
			promedio_data[d.Region_Colegio].Suma_Edad_Promedio += +d.Edad_Promedio;

			if (d.Comuna_Colegio in promedio_data[d.Region_Colegio]["comunas"]) { //si existía la comuna
				//se suma la nota del colegio actual a la ponderacion de la comuna
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Nota_Promedio += +d.Nota_Promedio;
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Nota_Mujeres += +d.Nota_Mujeres;
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Nota_Hombres += +d.Nota_Hombres;
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Asistencia_Promedio += +d.Asistencia_Promedio;
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Edad_Promedio += +d.Edad_Promedio;

				if (d.Nombre_Colegio in promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"]){ //si existía el colegio
					//se suma la nota del colegio actual a la ponderacion
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Nota_Promedio += +d.Nota_Promedio;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Nota_Mujeres += +d.Nota_Mujeres;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Nota_Hombres += +d.Nota_Hombres;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Asistencia_Promedio += +d.Asistencia_Promedio;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Edad_Promedio += +d.Edad_Promedio;
					
					if ((d.Curso +'_'+ d.Nivel_Educacion) in promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"]){ //si existía el curso
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].N_Letras += 1
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].N_Mujeres += +d.Num_Mujeres
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].N_Hombres += +d.Num_Hombres
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Nota_Promedio += +d.Nota_Promedio
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Nota_Mujeres += (+d.Nota_Mujeres*d.Num_Mujeres)
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Nota_Hombres += (+d.Nota_Hombres*d.Num_Hombres)
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Asistencia_Promedio += +d.Asistencia_Promedio
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Edad_Promedio += +d.Edad_Promedio
					}
					else{
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion] = {
							// "Letra": d.Letra_Curso, //para esto seria necesaria 1 profundidad extra q probablemente no se use
							"N_Letras": 1,
							"N_Mujeres": +d.Num_Mujeres,
							"N_Hombres": +d.Num_Hombres,
							"Suma_Nota_Promedio": +d.Nota_Promedio,
							"Suma_Nota_Mujeres": (+d.Nota_Mujeres*d.Num_Mujeres),
							"Suma_Nota_Hombres": (+d.Nota_Hombres*d.Num_Hombres),
							"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
							"Suma_Edad_Promedio": +d.Edad_Promedio
						}
					}
				}
				else{
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio] = { //se crea el colegio
						"N_Cursos": 0,
						"N_Cursos_Mujeres": 0, 
						"N_Cursos_Hombres": 0, 
						"Suma_Nota_Promedio": +d.Nota_Promedio,
						"Suma_Nota_Mujeres": +d.Nota_Mujeres,
						"Suma_Nota_Hombres": +d.Nota_Hombres,
						"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
						"Suma_Edad_Promedio": +d.Edad_Promedio,
						"Dependencia_Colegio": d.Dependencia_Colegio,
						"Ruralidad": d.Ruralidad,
						"cursos": {}
					}
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion] = {
						"N_Letras": 1,
						"N_Mujeres": +d.Num_Mujeres,
						"N_Hombres": +d.Num_Hombres,
						"Suma_Nota_Promedio": +d.Nota_Promedio,
						"Suma_Nota_Mujeres": (+d.Nota_Mujeres*d.Num_Mujeres),
						"Suma_Nota_Hombres": (+d.Nota_Hombres*d.Num_Hombres),
						"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
						"Suma_Edad_Promedio": +d.Edad_Promedio
					}

					//se agrega un colegio a la region y a la comuna
					promedio_data[d.Region_Colegio].N_Colegios += 1;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].N_Colegios += 1;
				}
			}
			else{
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio] = { //se crea la comuna
					"N_Colegios": 1,
					"N_Cursos": 0,
					"N_Cursos_Mujeres": 0, 
					"N_Cursos_Hombres": 0, 
					"Suma_Nota_Promedio": +d.Nota_Promedio,
					"Suma_Nota_Mujeres": +d.Nota_Mujeres,
					"Suma_Nota_Hombres": +d.Nota_Hombres,
					"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
					"Suma_Edad_Promedio": +d.Edad_Promedio,
					"Latitude": d.Lat_comuna,
					"Longitude": d.Lng_comuna,
					"colegios": {}
				}
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio] = {
					"N_Cursos": 0,
					"N_Cursos_Mujeres": 0, 
					"N_Cursos_Hombres": 0, 
					"Suma_Nota_Promedio": +d.Nota_Promedio,
					"Suma_Nota_Mujeres": +d.Nota_Mujeres,
					"Suma_Nota_Hombres": +d.Nota_Hombres,
					"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
					"Suma_Edad_Promedio": +d.Edad_Promedio,
					"Dependencia_Colegio": d.Dependencia_Colegio,
					"Ruralidad": d.Ruralidad,
					"cursos": {}
				}
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion] = {
					"N_Letras": 1,
					"N_Mujeres": +d.Num_Mujeres,
					"N_Hombres": +d.Num_Hombres,
					"Suma_Nota_Promedio": +d.Nota_Promedio,
					"Suma_Nota_Mujeres": (+d.Nota_Mujeres*d.Num_Mujeres),
					"Suma_Nota_Hombres": (+d.Nota_Hombres*d.Num_Hombres),
					"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
					"Suma_Edad_Promedio": +d.Edad_Promedio
				}

				promedio_data[d.Region_Colegio].N_Colegios += 1;
			}
		}
		else{
			promedio_data[d.Region_Colegio] = {
				"N_Colegios": 1,
				"N_Cursos": 0,
				"N_Cursos_Mujeres": 0, 
				"N_Cursos_Hombres": 0, 
				"Suma_Nota_Promedio": +d.Nota_Promedio,
				"Suma_Nota_Mujeres": +d.Nota_Mujeres,
				"Suma_Nota_Hombres": +d.Nota_Hombres,
				"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
				"Suma_Edad_Promedio": +d.Edad_Promedio,
				"Latitude": d.Lat_region,
				"Longitude": d.Lng_region,
				"comunas": {}
			}
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio] = {
				"N_Colegios": 1,
				"N_Cursos": 0,
				"N_Cursos_Mujeres": 0, 
				"N_Cursos_Hombres": 0, 
				"Suma_Nota_Promedio": +d.Nota_Promedio,
				"Suma_Nota_Mujeres": +d.Nota_Mujeres,
				"Suma_Nota_Hombres": +d.Nota_Hombres,
				"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
				"Suma_Edad_Promedio": +d.Edad_Promedio,
				"Latitude": d.Lat_comuna,
				"Longitude": d.Lng_comuna,
				"colegios": {}
			}
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio] = {
				"N_Cursos": 0,
				"N_Cursos_Mujeres": 0, 
				"N_Cursos_Hombres": 0, 
				"Suma_Nota_Promedio": +d.Nota_Promedio,
				"Suma_Nota_Mujeres": +d.Nota_Mujeres,
				"Suma_Nota_Hombres": +d.Nota_Hombres,
				"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
				"Suma_Edad_Promedio": +d.Edad_Promedio,
				"Dependencia_Colegio": d.Dependencia_Colegio,
				"Ruralidad": d.Ruralidad,
				"cursos": {}
			}
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion] = {
				"N_Letras": 1,
				"N_Mujeres": +d.Num_Mujeres,
				"N_Hombres": +d.Num_Hombres,
				"Suma_Nota_Promedio": +d.Nota_Promedio,
				"Suma_Nota_Mujeres": (+d.Nota_Mujeres*d.Num_Mujeres),
				"Suma_Nota_Hombres": (+d.Nota_Hombres*d.Num_Hombres),
				"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
				"Suma_Edad_Promedio": +d.Edad_Promedio
			}
		}

		if (d.Nota_Mujeres != 0) {
			promedio_data[d.Region_Colegio].N_Cursos_Mujeres += 1;
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].N_Cursos_Mujeres += 1;
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].N_Cursos_Mujeres += 1;
		}
		if (d.Nota_Hombres != 0) {
			promedio_data[d.Region_Colegio].N_Cursos_Hombres += 1;
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].N_Cursos_Hombres += 1;
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].N_Cursos_Hombres += 1;
		}

		promedio_data[d.Region_Colegio].N_Cursos += 1;
		promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].N_Cursos += 1;
		promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].N_Cursos += 1;
	}


///////////////////////////////////////////////////////
//          INICIALIZACION CANVAS DEL MAPA
///////////////////////////////////////////////////////

	var tile = d3.geo.tile()
			.size([map_width, height]);

	var projection = d3.geo.mercator()
		.scale((1 << 12) / 2 / Math.PI)
		// .scale((1 << 13) / 2 / Math.PI)
		.translate([-map_width / 2, -height / 2]); // just temporary

	var tileProjection = d3.geo.mercator();

	var tilePath = d3.geo.path()
			.projection(tileProjection);

	var geoPath = d3.geo.path().projection(projection);

	var zoom = d3.behavior.zoom()
			.scale(projection.scale() * 2 * Math.PI)
			// .scaleExtent([1 << 9, 1 << 25])
			.scaleExtent([1 << 11, 1 << 19])
			// .translate(projection([-73.978277, 40.6791989]).map(function(x) { return -x; }))
			.translate(projection([-70.1,-37.8]).map(function(x) { return -x; }))
			.on("zoom", zoomed);
			
	var container = d3.select("body").append("div")
			.attr("id", "container")
			.style("width", map_width + "px")
			.style("height", height + "px")
			.style("float", "left")
			.call(zoom);

	var map = container.append("g")
			.attr("id", "map")

	var points = container.append("svg")
			.attr("id", "points")

	var layer = map.append("div")
			.attr("class", "layer");

	var tip = d3.tip()
			.attr('class', 'd3-tip')
			.offset([-10, 0])
			.html(function(d) { 
				window.clearTimeout(actualizar_visualizaciones);
				// $("#loader").show();
				actualizar_visualizaciones = setTimeout(function(t) {
					actualizar_data(map=false)
				}, 2000);
				foreground.
					style("stroke", function(c){

						if (c.Nombre == d.Nombre){
							return "#F00"
						}
						else{
							if ("Region" in c){
								return color_regiones[c.Region]
							}
							else{ //si esta en la vista de regiones
								return color_regiones[c.Nombre]
							}
						}
					})

				return filtros.zoom + ": "+ d.Nombre + 
					"<br/>Num Colegios: " + d.N_Colegios + 
					"<br/>Promedio Notas: " + round(d.Promedio_Notas,2);
			})



	d3.json('regiones.topojson', function(error, chile) {
		d3.select("#points").selectAll("vector").data(topojson.feature(chile, chile.objects["chile-regions"]).features)
			.enter()
			.append("path")
			.attr("d", tilePath)
			.attr("class", "countries")
			// .style("fill", "red")
			.style("fill", function(d){
				// console.log(d.properties.Region)
				return color_regiones[d.properties.Region]
			})
			.style("stroke-width", 1)
			.style("stroke", "black")
			.style("fill-opacity", .5)
	});

	points.call(tip);
	zoomed();

	function createMap(dataset) {
		// rangos = [min_promedio_nota]
		rangos = [min_nota["selected_promedio"]]
		
		colors = []
		// console.log("rangos: ")
		for (var i = 1; i <= discretizacion; i++) {
			// rango_nota = min_promedio_nota+((max_promedio_nota - min_promedio_nota)/discretizacion)*i
			rango_nota = min_nota["selected_promedio"]+((max_nota["selected_promedio"] - min_nota["selected_promedio"])/discretizacion)*i
			color = get_discetized_color(rangos[i-1])
			// console.log("nota:",rangos[i-1],"\ncolor:", color)

			rangos.push(rango_nota)
			colors.push(color)
		}
		// console.log(rangos)
		write_legend(rangos, colors)

		d3.select("#points").selectAll("circle").data(dataset) //plotted 	locations on map
		.enter()
		.append("circle")
		.attr("cx", function(d) {return projection([d.Longitude,d.Latitude])[0]})
		.attr("cy", function(d) {return projection([d.Longitude,d.Latitude])[1]})
		.attr("class", "zona")
		.on('mouseover', tip.show)
		.on('mouseout', tip.hide)
		zoomed();
	}

	function clearMap(){
		d3.select("#points").selectAll("circle").remove();
		document.getElementById("my-legend").innerHTML = "";
	}

	function zoomed() {
		var tiles = tile
				.scale(zoom.scale())
				.translate(zoom.translate())
				();

		projection
				.scale(zoom.scale() / 2 / Math.PI)
				.translate(zoom.translate());

		d3.select("#points").selectAll("path")
			.attr("d", geoPath);


		if (filtros.zoom == "Region"){
			data = data_regiones
		}
		else{
			data = data_comunas
		}

		if (zoom.scale() >= 49667){
			if (filtros.zoom == "Region") { //modificar a vista de comunas
				filtros.zoom = "Comuna"
				max_nota["selected_promedio"] = max_nota["promedio_comuna"];
				min_nota["selected_promedio"] = min_nota["promedio_comuna"];
				// max_promedio_nota = max_nota["promedio_comuna"];
				// min_promedio_nota = min_nota["promedio_comuna"];

				$("#loader").show();
				actualizar_visualizaciones = setTimeout(actualizar_data, 200);
			}
		}
		else {
			if (filtros.zoom == "Comuna") { //modificar a vista de regiones
				filtros.zoom = "Region"
				max_nota["selected_promedio"] = max_nota["promedio_region"];
				min_nota["selected_promedio"] = min_nota["promedio_region"];
				// max_promedio_nota = max_nota["promedio_region"];
				// min_promedio_nota = min_nota["promedio_region"];

				$("#loader").show();
				actualizar_visualizaciones = setTimeout(actualizar_data, 200);
			}
		}

		window.clearTimeout(actualizar_visualizaciones);
		$("#loader").show();
		actualizar_visualizaciones = setTimeout(actualizar_data, 1000);

		var circles = d3.selectAll("circle")
				.attr("cx", function(d) {return projection([d.Longitude,d.Latitude])[0]})
				.attr("cy", function(d) {return projection([d.Longitude,d.Latitude])[1]})
				.attr("r", function(d) {
						// let escala = d.N_Colegios*.000001*zoom.scale();

					mult = 3 //significa que el mayor sera "mult" veces mas grande que el menor
					if (filtros.zoom == "Region") {
						// rescale = Math.log(d.N_Colegios)*.000001*zoom.scale();
						rescale = rescale_cant_colegios(d.N_Colegios, max_cant_colegios_region, min_cant_colegios_region, mult)
						let escala = rescale*.0005*zoom.scale();
						// return .0012*zoom.scale();
						return escala;
					}
					else if (filtros.zoom == "Comuna"){
						// rescale = (mult-1)/2900*d.N_Colegios + 1 - (mult-1)/29 //similar a usar escalamiento logaritmico pero con mayor control
						rescale = rescale_cant_colegios(d.N_Colegios, max_cant_colegios_comuna, min_cant_colegios_comuna, mult)
						let escala = rescale*.000025*zoom.scale();
						return escala;
					}
				})
				
				.attr("fill", function(d) { //coloreo
					return get_discetized_color(d.Promedio_Notas)
				})
				.attr("stroke", "black");

		var image = layer
				.style(prefix + "transform", matrix3d(tiles.scale, tiles.translate))
				.selectAll(".tile")
				.data(tiles, function(d) { return d; });

		image.exit()
				.remove();

		image.enter().append("img")
				.attr("class", "tile")
				.attr("src", function(d) { return "http://" + "abc"[d[1] % 3] + ".tile.openstreetmap.org/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
				// .attr("src", function(d) { return "http://" + ["a", "b", "c"][Math.random() * 3 | 0] + ".tile.openstreetmap.se/hydda/full/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
				.style("left", function(d) { return (d[0] << 8) + "px"; })
				.style("top", function(d) { return (d[1] << 8) + "px"; });
	}
	
	function write_legend(ranges, colors){
		html_to_write = "\
		<div id='legend-title'>Nota promedio</div>\
		<div id='legend-scale'>\
			<ul id='legend-labels'>"

				for (var i = 0; i < colors.length; i++) {
					// console.log(ranges[i+1])
					hex_color = rgbToHex(colors[i].r, colors[i].g, colors[i].b)
					if (i == 0){
						// html_to_write += "<li><span style='background:"+hex_color+";'></span>"+round(ranges[0],2).toString()+" - "+round(ranges[i+1],2).toString()+"</li>"
						html_to_write += "<li><span style='background: rgb("+colors[i].r+","+colors[i].g+","+colors[i].b+");'></span><span style='right: 9px; position: relative; width: auto;'>"+round(ranges[0],2).toString()+"</span><span style='right: -18px; position: relative; width: auto;'>"+round(ranges[i+1],2).toString()+"</span></li>"
						// html_to_write += "<li><span style='background:"+hex_color+";'></span><span style='right: 9px; position: relative; width: auto;'>"+round(ranges[0],2).toString()+"</span><span style='right: -18px; position: relative; width: auto;'>"+round(ranges[i+1],2).toString()+"</span></li>"
					}
					else{
						html_to_write += "<li><span style='background:"+hex_color+";'></span><span style='right: -10px; position: relative;'>"+round(ranges[i+1],2).toString()+"</span></li>"
					}
				}
			html_to_write += "</ul>\
		</div>";

		document.getElementById("my-legend").innerHTML = html_to_write;
	}

	function matrix3d(scale, translate) {
		var k = scale / 256, r = scale % 1 ? Number : Math.round;
		return "matrix3d(" + [k, 0, 0, 0, 0, k, 0, 0, 0, 0, k, 0, r(translate[0] * scale), r(translate[1] * scale), 0, 1 ] + ")";
	}

	function prefixMatch(p) {
		var i = -1, n = p.length, s = document.body.style;
		while (++i < n) if (p[i] + "Transform" in s) return "-" + p[i].toLowerCase() + "-";
		return "";
	}

	function formatLocation(p, k) {
		var format = d3.format("." + Math.floor(Math.log(k) / 2 - 2) + "f");
		return {"Latitude": parseFloat(format(p[1])), "Longitude": parseFloat(format(p[0]))}
	}

	function getScreenBounds() {
		izq_arriba = getPoint(0,0);
		der_abajo = getPoint();
		latitudes = {
			"Max": Math.max(izq_arriba["Latitude"], der_abajo["Latitude"]), 
			"Min": Math.min(izq_arriba["Latitude"], der_abajo["Latitude"])
		}
		longitudes = {
			"Max": Math.max(izq_arriba["Longitude"], der_abajo["Longitude"]), 
			"Min": Math.min(izq_arriba["Longitude"], der_abajo["Longitude"])
		}
		return {"Latitude": latitudes, "Longitude": longitudes}
	}

	function getPoint(x,y) {
		if (x == null) x = map_width;
		if (y == null) y = height;  
		var point = points.node().createSVGPoint();
		point.x = x, point.y = y;
		point = point.matrixTransform(points.node().getScreenCTM().inverse());
		return formatLocation(projection.invert([point.x, point.y]), zoom.scale());
	}


///////////////////////////////////////////////////////
//     INICIALIZACION CANVAS DE COORD PARALELAS
///////////////////////////////////////////////////////
	var tooltip = d3.select("body")
		.append("div")
		.style("position", "absolute")
		.style("z-index", "10")
		.style("visibility", "hidden")
		.text("a simple tooltip")
		.attr("class","tooltip2");

	var margin = {
		top: 30, 
		right: 10, 
		bottom: 10, 
		left: 10
	},
	c_width = coord_width - margin.left - margin.right,
	c_height = coord_height - margin.top - margin.bottom;

	var x = d3.scale.ordinal().rangePoints([0, c_width], 1),
			y = {},
			dragging = {};

	var line = d3.svg.line(),
			axis = d3.svg.axis().orient("left"),
			background,
			foreground,
			svg;

	function createCoordParalelas(dataset){

		svg = d3.select("body").append("svg")
			.attr("id", "coordenadas_paralelas")
			.attr("width", c_width + margin.left + margin.right)
			.attr("height", c_height + margin.top + margin.bottom)
			// .attr("style", "position: absolute; top: 100px; right: 0.5%;")
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		// let notas_done = false
		x.domain(dimensions = d3.keys(dataset[0]).filter(function(d) {
			if (d != "Nombre" && d != "Longitude" && d != "Latitude" && d != "Region"){
				 y[d] = d3.scale.linear()
					.domain(d3.extent(dataset, function(p) { 

						return +p[d]; 
					}))
					.range([c_height, 0]);
				return y[d];
			}
			else{
				// asd = d3.scale.domain(dataset, function(p) {
				// 	return p[d]
				// })
				// console.log(asd)
				return false
			}

		}));

		// x.domain().push("Nombre")

		// usar los mismos dominios para las cordenadas de las notas
		for (var i = 0; i < d3.keys(dataset[0]).length; i++) {
			dominio = d3.keys(dataset[0])[i]
			if (dominio == "Promedio_Notas" || dominio == "Promedio_Mujeres" || dominio == "Promedio_Hombres"){
				// if (filtros.zoom == "Region"){
				// 	y[dominio].domain([min_nota["total_region"], max_nota["total_region"]])
				// }
				// else{
				// 	y[dominio].domain([min_nota["total_comuna"], max_nota["total_comuna"]])
				// }
				y[dominio].domain([min_nota["selected_total"], max_nota["selected_total"]])
			}
		}


		// Add grey background lines for context.
		background = svg.append("g")
			.attr("class", "background")
			.selectAll("path")
			.data(dataset)
			.enter().append("path")
			.attr("d", path);

		// Add blue foreground lines for focus.
		foreground = svg.append("g")
			.attr("class", "foreground")
			.selectAll("path")
			.data(dataset)
			.enter().append("path")
			.attr("d", path)
			.attr("style", function(d){
				if ("Region" in d){
					return "stroke: "+color_regiones[d.Region]
				}
				else{ //si esta en la vista de regiones
					return "stroke: "+color_regiones[d.Nombre]
				}
			})
			.on("mouseover", function(n){
				d3.select(this).transition().duration(100)
				.style({'stroke' : '#F00'});
				tooltip.text(n.Nombre);
				return tooltip.style("visibility", "visible");
			})
			.on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
			.on("mouseout", function(d){
				d3.select(this).transition().duration(100)
				.attr("style", function(n){
					if ("Region" in d){
						color = String(hexToR(color_regiones[d.Region]))+","+String(hexToG(color_regiones[d.Region]))+","+String(hexToB(color_regiones[d.Region]))
						// color = color_regiones[d.Region]
						// console.log(color)
						// return "stroke: #555"
						// return color
					}
					else{ //si esta en la vista de regiones
						color = String(hexToR(color_regiones[d.Nombre]))+","+String(hexToG(color_regiones[d.Nombre]))+","+String(hexToB(color_regiones[d.Nombre]))
						// color = color_regiones[d.Nombre]
						// console.log(color)
						// return "stroke: #555"
						// return color
					}
					return "stroke: rgb("+color+")"
				})
				// .style({'stroke-width' : '2'});
				return tooltip.style("visibility", "hidden");
			});

		// Add a group element for each dimension.
		var g = svg.selectAll(".dimension")
		.data(dimensions)
			.enter().append("g")
			.attr("class", "dimension")
			.attr("transform", function(d) { 
				return "translate(" + x(d) + ")"; 
			})
			.call(d3.behavior.drag() //arrastrar las dimensiones
				.origin(function(d) { 
					return {x: x(d)
					};
				})
				.on("dragstart", function(d) {
					dragging[d] = x(d);
					background.attr("visibility", "hidden");
				})
				.on("drag", function(d) {
					dragging[d] = Math.min(width, Math.max(0, d3.event.x));
					foreground.attr("d", path);
					dimensions.sort(function(a, b) {
						return position(a) - position(b);
					});
					x.domain(dimensions);
					g.attr("transform", function(d) { 
						return "translate(" + position(d) + ")";
					})
				})
				.on("dragend", function(d) {
					delete dragging[d];
					transition(d3.select(this))
						.attr("transform", "translate(" + x(d) + ")");
					transition(foreground).attr("d", path);
					background
						.attr("d", path)
						.transition()
						.delay(500)
						.duration(0)
						.attr("visibility", null);
				})
			);

		// Add an axis and title.
		g.append("g")
			.attr("class", "axis")
			.each(function(d) {
				d3.select(this).call(axis.scale(y[d]));
			})
			.append("text")
			.style("text-anchor", "middle")
			.attr("y", -9)
			.text(function(d) {
				return d;
			});

		// Add and store a brush for each axis.
		g.append("g")
			.attr("class", "brush")
			.each(function(d) {
				d3.select(this).call(y[d].brush = d3.svg.brush().y(y[d]).on("brushstart", brushstart).on("brush", brush));
			})
			.selectAll("rect")
			.attr("x", -8)
			.attr("width", 16);
	}

	function clearCoordParalelas(){
		coordenadas_paralelas = document.getElementById("coordenadas_paralelas")
		if (coordenadas_paralelas){
			coordenadas_paralelas.remove();
		}
	}

	function position(d) {
		var v = dragging[d];
		return v == null ? x(d) : v;
	}

	function transition(g) {
		return g.transition().duration(500);
	}

	// Returns the path for a given data point.
	function path(d) {
		return line(dimensions.map(function(p){
			return [position(p), y[p](d[p])]; 
		}));
	}

	function brushstart() {
		d3.event.sourceEvent.stopPropagation();
	}

	// Handles a brush event, toggling the display of foreground lines.
	function brush() {
		var actives = dimensions.filter(function(p) { 
			return !y[p].brush.empty(); 
		}),
		extents = actives.map(function(p) { 
			return y[p].brush.extent(); 
		});

		filtros["Coordenadas_Paralelas"] = {
			"N_Colegios": {"min": null, "max": null},
			"Asistencia_Promedio": {"min": null, "max": null},
			"Promedio_Notas": {"min": null, "max": null},
			"Promedio_Mujeres": {"min": null, "max": null},
			"Promedio_Hombres": {"min": null, "max": null}
		}

		for (var i = actives.length - 1; i >= 0; i--) {
			filtros["Coordenadas_Paralelas"][actives[i]]["min"] = extents[i][0]
			filtros["Coordenadas_Paralelas"][actives[i]]["max"] = extents[i][1]
		}

		window.clearTimeout(actualizar_visualizaciones);
		$("#loader").show();
		actualizar_visualizaciones = setTimeout(function(t) {
			actualizar_data(true,false)
		}, 1000);

		foreground.style("display", function(d) {
			return actives.every(function(p, i) {
				return extents[i][0] <= d[p] && d[p] <= extents[i][1];
			}) ? null : "none";
		});
	}

	function createBars(dataset){
	}

	function clearBars(){
	}

</script>

	<div id="titulo">
		<h3 id="texto"><center>Notas de Chile</center> </h3>
	</div>

	<div id='my-legend'>
	</div>

	<div id="filtros" class="card bg-light mb-3" >
		<div class="card-header">Filtros - Tipo de Colegios
			<div id="loader"></div>
		</div>
		<div class="card-body">

			<div class="input-group mb-3">
				<div class="input-group-prepend">
					<label class="input-group-text" for="select_ruralidad">Dependencia</label>
				</div>
				<select id="dep_colegio" class="custom-select" id="select_dep_colegio" onchange="read_dataset('Dependencia_Colegio',$('#dep_colegio')[0].value);">
					<option value="null" selected>Todos</option>
					<option>Municipal</option>
					<option>Particular Subvencionado</option>
					<option>Particular Pagado</option>
					<option>Corporacion de Administracion Delegada</option>
				</select>
			</div>

			<div class="input-group mb-3">
				<div class="input-group-prepend">
					<label class="input-group-text" for="select_ruralidad">Ruralidad</label>
				</div>
				<select id="ruralidad" class="custom-select" id="select_ruralidad" onchange="read_dataset('Ruralidad',$('#ruralidad')[0].value);">
					<option value="null" selected>Todos</option>
					<option>Rural</option>
					<option>Urbano</option>
				</select>
			</div>

			<div class="input-group mb-3">
				<div class="input-group-prepend">
					<label class="input-group-text" for="select_ruralidad">Año estudio</label>
				</div>
				<select id="agno" class="custom-select" id="select_agno" onchange="read_dataset('Agno',$('#agno')[0].value);">
					<option value="null" selected>Historico</option>
					<option>2013</option>
					<option>2014</option>
					<option>2015</option>
					<option>2016</option>
					<option>2017</option>
				</select>
			</div>
		</div>
	</div>

</body>
</html>