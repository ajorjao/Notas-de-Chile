<!DOCTYPE html>
<meta charset="utf-8">

<style>

	body {
		margin: 0;
		overflow-y: hidden;
	}
	/*mapa*/
		#container {
			position: relative;
			overflow: hidden;
			background: #ddd;
		}

		#map{
			width:100%;
			height:100%;
		}

		#points{
			width:100%;
			height:100%;
			position:relative;
			z-index:100;
		}

		.layer {
			position: absolute;
		}

		.tile {
			pointer-events: none;
			position: absolute;
			width: 256px;
			height: 256px;
		}

		.zona{
			opacity: 0.85;
			/*fill: #ff2200;*/
		}

		.zona:hover{
			opacity: 1.0;
			/*fill: #ff8a00;*/
		}

		.d3-tip {
			line-height: 1.5;
			font-weight: normal;
			font-family: Helvetica, Arial, sans-serif;
			font-size:13px;
			padding: 10px;
			background: rgba(0, 0, 0, 0.8);
			color: #fff;
			border-radius: 3px;
			position:relative;
			z-index:101;
		}

		.d3-tip:after {
			box-sizing: border-box;
			display: inline;
			font-size: 20px;
			width: 100%;
			line-height: .5;
			color: rgba(0, 0, 0, 0.8);
			content: "\25BC";
			position: absolute;
			text-align: center;
		}

		.d3-tip.n:after {
			margin: -1px 0 0 0;
			top: 100%;
			left: 0;
		}

		#my-legend {
			position: absolute;
			top: 0;
			z-index: 100;
			padding: 10px;
			background-color: rgba(175, 175, 175, 0.7);
			border-radius: 15px;
			margin: 3px;
		}
		#my-legend #legend-title {
			text-align: left;
			margin-bottom: 8px;
			font-weight: bold;
			font-size: 90%;
		}
		#my-legend #legend-scale ul {
			margin: 0;
			padding: 0;
			float: left;
			list-style: none;
		}
		#my-legend #legend-scale ul li {
			display: block;
			float: left;
			width: 50px;
			margin-bottom: 6px;
			text-align: right;
			font-size: 80%;
			list-style: none;
		}
		#my-legend ul#legend-labels li span {
			display: block;
			float: left;
			height: 15px;
			width: 50px;
		}
		#my-legend #legend-source {
			font-size: 70%;
			color: #999;
			clear: both;
		}
		#my-legend a {
			color: #777;
		}

	/*coordenadas paralelas*/
		svg {
			font: 10px sans-serif;
		}

		.background path {
			fill: none;
			stroke: #ddd;
			shape-rendering: crispEdges;
		}

		.foreground path {
			fill: none;
			/*stroke: steelblue;*/
			stroke-width: 2;
		}

		.brush .extent {
			fill-opacity: .3;
			stroke: #fff;
			shape-rendering: crispEdges;
		}

		.axis line,
		.axis path {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}

		.axis text {
			text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
			cursor: move;
		}

		.tooltip {
			background-color: rgba(220,220,220,0.8);
			color: #333;
			margin: 10px;
			height: 25px;
			padding-right: 10px;
			padding-left: 10px; 
			padding-top: 10px;
			-webkit-border-radius:10px;
			-moz-border-radius:10px;
			border-radius:10px;
		}
</style>

<body>
<script src="d3.v3.min.js"></script>
<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<script src="d3.geo.tile.v0.min.js"></script>
<!-- <script src="http://d3js.org/d3.geo.tile.v0.min.js"></script> -->
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="d3.tip.js"></script>

<script>

//NOTA: TODO ESTO SE BORRARA A FUTURO, PERO POR AHORA SE DEJA AQUI PARA PROBAR DATOS MÁS FACILMENTE
/////////////////// Parametros ////////////////////////
filtros = {
	"zoom_type": "Automatico", // si se acerca lo suficiente, la vista se cambia a la de comunas (hace que se ignore la variable "zoom")
	// "zoom_type": "Manual", // se puede modificar el zoom sin que se modifiquen los datos que se están mostrando
	"zoom": "Region", 
	// "zoom": "Comuna", 

	// "Escala_Cant_Colegios": false, //si se desea cambiar el tamaño los circulos acorde a la cantidad de colegios de la zona
	"Escala_Cant_Colegios": true,

	"Dependencia_Colegio": null, 
	// "Dependencia_Colegio": "Municipal", 
	// "Dependencia_Colegio": "Particular Subvencionado", 
	// "Dependencia_Colegio": "Particular Pagado", 
	// "Dependencia_Colegio": "Corporacion de Administracion Delegada", 

	"Ruralidad": null, 
	// "Ruralidad": "Rural", 
	// "Ruralidad": "Urbano", 

	"Agno": null,
	// "Agno": "2013",
	// "Agno": "2014",
	// "Agno": "2015",
	// "Agno": "2016",
	// "Agno": "2017",

	"Genero": null,
	// "Genero": "Hombres",
	// "Genero": "Mujeres",
};
///////////////////////////////////////////////////////


///////////////////////////////////////////////////////
//       MANEJO DE COLORES Y REESCALAMIENTO MAPA
///////////////////////////////////////////////////////

	function rescale_cant_colegios(val, max, min, mult){ //el mayor sera "mult" veces mas grande que el menor
		return (mult-1)/(max-min)*val + 1 - (mult-1)*(min/(max-min)) //similar a usar escalamiento logaritmico pero con mayor control
	}

	function get_discetized_color(nota){
		deltas = (max_promedio_nota - min_promedio_nota)/discretizacion
		pend_discretizada_color = 255/discretizacion

		alpha = parseInt(round(round(nota - min_promedio_nota, 6) / round(deltas, 6), 4))

		bueno = pend_discretizada_color*alpha
		malo = pend_discretizada_color*(discretizacion - alpha)

		// return d3.rgb(0,bueno,malo) // rojo, verde, azul
		return d3.rgb(malo,0,bueno) // rojo, verde, azul
	}

	function componentToHex(c) {
			var hex = c.toString(16);
			return hex.length == 1 ? "0" + hex : hex;
	}

	function rgbToHex(r, g, b) {
			return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
	}

	function round(x, decimales){
		return Math.round(x*10**decimales)/10**decimales
	}


///////////////////////////////////////////////////////
//     VARIABLES GLOBALES PARA MANEJO DE DATOS
///////////////////////////////////////////////////////

	var width = Math.max(960, window.innerWidth),
			height = Math.max(500, window.innerHeight),
			prefix = prefixMatch(["webkit", "ms", "Moz", "O"]);
		
	color_regiones = {"Arica y Parinacota": "#d98880", //ordenadas de norte a sur
			"Tarapaca": "#f1948a", 
			"Antofagasta": "#c39bd3", 
			"Atacama": "#bb8fce", 
			"Coquimbo": "#7fb3d5", 
			"Valparaiso": "#85c1e9",
			"Metropolitana": "#76d7c4",
			"Gral Bernardo OHiggins": "#73c6b6",
			"Maule": "#7dcea0", 
			"Biobio": "#82e0aa", 
			"Araucania": "#f7dc6f", 
			"Los Rios": "#f8c471",  
			"Los Lagos": "#f0b27a",
			"Aysen": "#e59866",
			"Magallanes": "#bfc9ca"}


	var map_width = width*0.345; //el mapa usara un 35% del ancho de la pantalla
	var coord_width = width*0.645; //el grafico de coordenadas paralelas usara un 65% del ancho de la pantalla
	var coord_height = height*0.5;

	var data_regiones = [];
	var data_comunas = [];
	var max_nota_comuna = 2;
	var min_nota_comuna = 7;
	var max_nota_region = 2;
	var min_nota_region = 7;
	var max_promedio_nota = 0;
	var min_promedio_nota = 0;
	var max_nota = {"promedio_region": 0, "mujer_region": 0, "hombre_region": 0, "total_region": 0, "promedio_comuna": 0, "mujer_comuna": 0, "hombre_comuna": 0, "total_comuna": 0} //total es para mujeres, hombres y promedios (usado en coord paralalelas)
	var min_nota = {"promedio_region": 7, "mujer_region": 7, "hombre_region": 7, "total_region": 7, "promedio_comuna": 7, "mujer_comuna": 7, "hombre_comuna": 7, "total_comuna": 7}
	var max_cant_colegios_comuna = 0;
	var min_cant_colegios_comuna = 3000;
	var max_cant_colegios_region = 0;
	var min_cant_colegios_region = 3000;
	var discretizacion = 5; //cuantos colores distintos para diferenciar en la leyenda
	var promedio_data = {};



///////////////////////////////////////////////////////
//          MANEJO DE DATOS DEL CSV
///////////////////////////////////////////////////////

	d3.csv("Rendimiento_por_cursos_georeferenciados3.csv", type, function(error, dataset) { 
		if (error) throw error;

		let nombre_region;
		let region;
		let nombre_comuna;
		let comuna;

		let promedio_nota;

		// se buscan los datos maximos y minimos de n_colegios y promedios
		// ademas se guarda la data en data_regiones y data_comunas (se guarda Nombre, N_Colegios, Promedio_Notas, Longitude, Latitude)
		for (var i = 0; i < Object.keys(promedio_data).length; i++) {
			nombre_region = Object.keys(promedio_data)[i]
			region = promedio_data[nombre_region]

			promedio_mujeres = (region.Suma_Nota_Mujeres/region.N_Cursos_Mujeres);
			promedio_hombres = (region.Suma_Nota_Hombres/region.N_Cursos_Hombres);
			promedio_nota = (region.Suma_Nota_Promedio/region.N_Cursos);
			asistencia_promedio = (region.Suma_Asistencia_Promedio/region.N_Cursos);
			// edad_promedio = (region.Suma_Edad_Promedio/region.N_Cursos);

			cant_colegios = region.N_Colegios;
			// if (promedio_nota > max_nota_region) {max_nota_region = promedio_nota};
			// if (promedio_nota < min_nota_region) {min_nota_region = promedio_nota};
			if (promedio_nota > max_nota["promedio_region"]) {max_nota["promedio_region"] = promedio_nota};
			if (promedio_nota < min_nota["promedio_region"]) {min_nota["promedio_region"] = promedio_nota};
			if (promedio_mujeres > max_nota["mujer_region"]) {max_nota["mujer_region"] = promedio_mujeres};
			if (promedio_mujeres < min_nota["mujer_region"]) {min_nota["mujer_region"] = promedio_mujeres};
			if (promedio_hombres > max_nota["hombre_region"]) {max_nota["hombre_region"] = promedio_hombres};
			if (promedio_hombres < min_nota["hombre_region"]) {min_nota["hombre_region"] = promedio_hombres};
			if (Math.max(promedio_nota, promedio_mujeres, promedio_hombres) > max_nota["total_region"]){
				max_nota["total_region"] = Math.max(promedio_nota, promedio_mujeres, promedio_hombres)
			};
			if (Math.min(promedio_nota, promedio_mujeres, promedio_hombres) < min_nota["total_region"]){
				min_nota["total_region"] = Math.min(promedio_nota, promedio_mujeres, promedio_hombres)
			};
			if (promedio_nota < min_nota["total_region"]) {min_nota["total_region"] = promedio_nota};
			if (cant_colegios > max_cant_colegios_region) {max_cant_colegios_region = cant_colegios};
			if (cant_colegios < min_cant_colegios_region) {min_cant_colegios_region = cant_colegios};
			data_regiones.push({
				Nombre: nombre_region, 
				N_Colegios: region.N_Colegios, 
				Asistencia_Promedio: asistencia_promedio,
				Promedio_Notas: promedio_nota, 
				Promedio_Mujeres: promedio_mujeres, 
				Promedio_Hombres: promedio_hombres, 
				// Edad_Promedio: edad_promedio,
				Longitude: +region.Longitude, 
				Latitude: +region.Latitude, 
			})
			for (var j = 0; j < Object.keys(region.comunas).length; j++) {
				nombre_comuna = Object.keys(region.comunas)[j];
				comuna = region.comunas[nombre_comuna];

				promedio_mujeres = (comuna.Suma_Nota_Mujeres/comuna.N_Cursos_Mujeres);
				promedio_hombres = (comuna.Suma_Nota_Hombres/comuna.N_Cursos_Hombres);
				promedio_nota = (comuna.Suma_Nota_Promedio/comuna.N_Cursos);
				asistencia_promedio = (comuna.Suma_Asistencia_Promedio/comuna.N_Cursos);
				edad_promedio = (comuna.Suma_Edad_Promedio/comuna.N_Cursos);

				cant_colegios = comuna.N_Colegios;
				// if (promedio_nota > max_nota_comuna) {max_nota_comuna = promedio_nota};
				// if (promedio_nota < min_nota_comuna) {min_nota_comuna = promedio_nota};
				if (promedio_nota > max_nota["promedio_comuna"]) {max_nota["promedio_comuna"] = promedio_nota};
				if (promedio_nota < min_nota["promedio_comuna"]) {min_nota["promedio_comuna"] = promedio_nota};
				if (promedio_mujeres > max_nota["mujer_comuna"]) {max_nota["mujer_comuna"] = promedio_mujeres};
				if (promedio_mujeres < min_nota["mujer_comuna"]) {min_nota["mujer_comuna"] = promedio_mujeres};
				if (promedio_hombres > max_nota["hombre_comuna"]) {max_nota["hombre_comuna"] = promedio_hombres};
				if (promedio_hombres < min_nota["hombre_comuna"]) {min_nota["hombre_comuna"] = promedio_hombres};
				if (Math.max(promedio_nota, promedio_mujeres, promedio_hombres) > max_nota["total_comuna"]){
					max_nota["total_comuna"] = Math.max(promedio_nota, promedio_mujeres, promedio_hombres)
				};
				if (Math.min(promedio_nota, promedio_mujeres, promedio_hombres) < min_nota["total_comuna"]){
					min_nota["total_comuna"] = Math.min(promedio_nota, promedio_mujeres, promedio_hombres)
				};
				if (cant_colegios > max_cant_colegios_comuna) {max_cant_colegios_comuna = cant_colegios};
				if (cant_colegios < min_cant_colegios_comuna) {min_cant_colegios_comuna = cant_colegios};
				data_comunas.push({
					Nombre: nombre_comuna, 
					Region: nombre_region,
					N_Colegios: comuna.N_Colegios, 
					Asistencia_Promedio: asistencia_promedio,
					Promedio_Notas: promedio_nota, 
					Promedio_Mujeres: promedio_mujeres, 
					Promedio_Hombres: promedio_hombres, 
					Edad_Promedio: edad_promedio,
					Longitude: +comuna.Longitude, 
					Latitude: +comuna.Latitude
				})
			}
			// }
		}

		//creacion del mapa inicial
		// if (filtros.zoom == "Region"){
			// max_promedio_nota = max_nota_region;
			// min_promedio_nota = min_nota_region;
			max_promedio_nota = max_nota["promedio_region"];
			min_promedio_nota = min_nota["promedio_region"];
			createMap(data_regiones)
		// }
		// else if (filtros.zoom == "Comuna"){
		//   max_promedio_nota = max_nota_comuna;
		//   min_promedio_nota = min_nota_comuna;
		//   createMap(data_comunas)
		// }

		createCoordParalelas(data_regiones)

	});

	// recopilacion de datos y se guardan en "promedio_data", por cada fila del csv se ejecuta el siguiente codigo
	function type(d) {
		if (filtros.Dependencia_Colegio != null && filtros.Dependencia_Colegio != d.Dependencia_Colegio) {
			return null;
		}

		if (filtros.Ruralidad != null && filtros.Ruralidad != d.Ruralidad) {
			return null;
		}

		if (filtros.Agno != null && filtros.Agno != d.Agno) {
			return null;
		}

		d.Nivel_Educacion = d.Nivel_Educacion.replace(/a$/,"o") // para decir en vez de 1_Basica -> 1_Basico

		if (d.Region_Colegio in promedio_data){ //si existía la reguion
			//se suma la nota del colegio actual a la ponderacion de la region
			promedio_data[d.Region_Colegio].Suma_Nota_Promedio += +d.Nota_Promedio;
			promedio_data[d.Region_Colegio].Suma_Nota_Mujeres += +d.Nota_Mujeres;
			promedio_data[d.Region_Colegio].Suma_Nota_Hombres += +d.Nota_Hombres;
			promedio_data[d.Region_Colegio].Suma_Asistencia_Promedio += +d.Asistencia_Promedio;
			promedio_data[d.Region_Colegio].Suma_Edad_Promedio += +d.Edad_Promedio;

			if (d.Comuna_Colegio in promedio_data[d.Region_Colegio]["comunas"]) { //si existía la comuna
				//se suma la nota del colegio actual a la ponderacion de la comuna
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Nota_Promedio += +d.Nota_Promedio;
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Nota_Mujeres += +d.Nota_Mujeres;
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Nota_Hombres += +d.Nota_Hombres;
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Asistencia_Promedio += +d.Asistencia_Promedio;
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].Suma_Edad_Promedio += +d.Edad_Promedio;

				if (d.Nombre_Colegio in promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"]){ //si existía el colegio
					//se suma la nota del colegio actual a la ponderacion
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Nota_Promedio += +d.Nota_Promedio;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Nota_Mujeres += +d.Nota_Mujeres;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Nota_Hombres += +d.Nota_Hombres;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Asistencia_Promedio += +d.Asistencia_Promedio;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].Suma_Edad_Promedio += +d.Edad_Promedio;
					
					if ((d.Curso +'_'+ d.Nivel_Educacion) in promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"]){ //si existía el curso
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].N_Letras += 1
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].N_Mujeres += +d.Num_Mujeres
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].N_Hombres += +d.Num_Hombres
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Nota_Promedio += +d.Nota_Promedio
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Nota_Mujeres += (+d.Nota_Mujeres*d.Num_Mujeres)
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Nota_Hombres += (+d.Nota_Hombres*d.Num_Hombres)
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Asistencia_Promedio += +d.Asistencia_Promedio
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion].Suma_Edad_Promedio += +d.Edad_Promedio
					}
					else{
						promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion] = {
							// "Letra": d.Letra_Curso, //para esto seria necesaria 1 profundidad extra q probablemente no se use
							"N_Letras": 1,
							"N_Mujeres": +d.Num_Mujeres,
							"N_Hombres": +d.Num_Hombres,
							"Suma_Nota_Promedio": +d.Nota_Promedio,
							"Suma_Nota_Mujeres": (+d.Nota_Mujeres*d.Num_Mujeres),
							"Suma_Nota_Hombres": (+d.Nota_Hombres*d.Num_Hombres),
							"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
							"Suma_Edad_Promedio": +d.Edad_Promedio
						}
					}
				}
				else{
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio] = { //se crea el colegio
						"N_Cursos": 0,
						"N_Cursos_Mujeres": 0, 
						"N_Cursos_Hombres": 0, 
						"Suma_Nota_Promedio": +d.Nota_Promedio,
						"Suma_Nota_Mujeres": +d.Nota_Mujeres,
						"Suma_Nota_Hombres": +d.Nota_Hombres,
						"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
						"Suma_Edad_Promedio": +d.Edad_Promedio,
						"Dependencia_Colegio": d.Dependencia_Colegio,
						"Ruralidad": d.Ruralidad,
						"cursos": {}
					}
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion] = {
						"N_Letras": 1,
						"N_Mujeres": +d.Num_Mujeres,
						"N_Hombres": +d.Num_Hombres,
						"Suma_Nota_Promedio": +d.Nota_Promedio,
						"Suma_Nota_Mujeres": (+d.Nota_Mujeres*d.Num_Mujeres),
						"Suma_Nota_Hombres": (+d.Nota_Hombres*d.Num_Hombres),
						"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
						"Suma_Edad_Promedio": +d.Edad_Promedio
					}

					//se agrega un colegio a la region y a la comuna
					promedio_data[d.Region_Colegio].N_Colegios += 1;
					promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].N_Colegios += 1;
				}
			}
			else{
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio] = { //se crea la comuna
					"N_Colegios": 1,
					"N_Cursos": 0,
					"N_Cursos_Mujeres": 0, 
					"N_Cursos_Hombres": 0, 
					"Suma_Nota_Promedio": +d.Nota_Promedio,
					"Suma_Nota_Mujeres": +d.Nota_Mujeres,
					"Suma_Nota_Hombres": +d.Nota_Hombres,
					"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
					"Suma_Edad_Promedio": +d.Edad_Promedio,
					"Latitude": d.Lat_comuna,
					"Longitude": d.Lng_comuna,
					"colegios": {}
				}
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio] = {
					"N_Cursos": 0,
					"N_Cursos_Mujeres": 0, 
					"N_Cursos_Hombres": 0, 
					"Suma_Nota_Promedio": +d.Nota_Promedio,
					"Suma_Nota_Mujeres": +d.Nota_Mujeres,
					"Suma_Nota_Hombres": +d.Nota_Hombres,
					"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
					"Suma_Edad_Promedio": +d.Edad_Promedio,
					"Dependencia_Colegio": d.Dependencia_Colegio,
					"Ruralidad": d.Ruralidad,
					"cursos": {}
				}
				promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion] = {
					"N_Letras": 1,
					"N_Mujeres": +d.Num_Mujeres,
					"N_Hombres": +d.Num_Hombres,
					"Suma_Nota_Promedio": +d.Nota_Promedio,
					"Suma_Nota_Mujeres": (+d.Nota_Mujeres*d.Num_Mujeres),
					"Suma_Nota_Hombres": (+d.Nota_Hombres*d.Num_Hombres),
					"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
					"Suma_Edad_Promedio": +d.Edad_Promedio
				}

				promedio_data[d.Region_Colegio].N_Colegios += 1;
			}
		}
		else{
			promedio_data[d.Region_Colegio] = {
				"N_Colegios": 1,
				"N_Cursos": 0,
				"N_Cursos_Mujeres": 0, 
				"N_Cursos_Hombres": 0, 
				"Suma_Nota_Promedio": +d.Nota_Promedio,
				"Suma_Nota_Mujeres": +d.Nota_Mujeres,
				"Suma_Nota_Hombres": +d.Nota_Hombres,
				"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
				"Suma_Edad_Promedio": +d.Edad_Promedio,
				"Latitude": d.Lat_region,
				"Longitude": d.Lng_region,
				"comunas": {}
			}
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio] = {
				"N_Colegios": 1,
				"N_Cursos": 0,
				"N_Cursos_Mujeres": 0, 
				"N_Cursos_Hombres": 0, 
				"Suma_Nota_Promedio": +d.Nota_Promedio,
				"Suma_Nota_Mujeres": +d.Nota_Mujeres,
				"Suma_Nota_Hombres": +d.Nota_Hombres,
				"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
				"Suma_Edad_Promedio": +d.Edad_Promedio,
				"Latitude": d.Lat_comuna,
				"Longitude": d.Lng_comuna,
				"colegios": {}
			}
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio] = {
				"N_Cursos": 0,
				"N_Cursos_Mujeres": 0, 
				"N_Cursos_Hombres": 0, 
				"Suma_Nota_Promedio": +d.Nota_Promedio,
				"Suma_Nota_Mujeres": +d.Nota_Mujeres,
				"Suma_Nota_Hombres": +d.Nota_Hombres,
				"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
				"Suma_Edad_Promedio": +d.Edad_Promedio,
				"Dependencia_Colegio": d.Dependencia_Colegio,
				"Ruralidad": d.Ruralidad,
				"cursos": {}
			}
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio]["cursos"][d.Curso +'_'+ d.Nivel_Educacion] = {
				"N_Letras": 1,
				"N_Mujeres": +d.Num_Mujeres,
				"N_Hombres": +d.Num_Hombres,
				"Suma_Nota_Promedio": +d.Nota_Promedio,
				"Suma_Nota_Mujeres": (+d.Nota_Mujeres*d.Num_Mujeres),
				"Suma_Nota_Hombres": (+d.Nota_Hombres*d.Num_Hombres),
				"Suma_Asistencia_Promedio": +d.Asistencia_Promedio,
				"Suma_Edad_Promedio": +d.Edad_Promedio
			}
		}

		if (d.Nota_Mujeres != 0) {
			promedio_data[d.Region_Colegio].N_Cursos_Mujeres += 1;
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].N_Cursos_Mujeres += 1;
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].N_Cursos_Mujeres += 1;
		}
		if (d.Nota_Hombres != 0) {
			promedio_data[d.Region_Colegio].N_Cursos_Hombres += 1;
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].N_Cursos_Hombres += 1;
			promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].N_Cursos_Hombres += 1;
		}

		promedio_data[d.Region_Colegio].N_Cursos += 1;
		promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio].N_Cursos += 1;
		promedio_data[d.Region_Colegio]["comunas"][d.Comuna_Colegio]["colegios"][d.Nombre_Colegio].N_Cursos += 1;
	}


///////////////////////////////////////////////////////
//          INICIALIZACION CANVAS DEL MAPA
///////////////////////////////////////////////////////

	var tile = d3.geo.tile()
			.size([map_width, height]);

	var projection = d3.geo.mercator()
		.scale((1 << 12) / 2 / Math.PI)
		// .scale((1 << 13) / 2 / Math.PI)
		.translate([-map_width / 2, -height / 2]); // just temporary

	var tileProjection = d3.geo.mercator();

	var tilePath = d3.geo.path()
			.projection(tileProjection);

	var geoPath = d3.geo.path().projection(projection);

	var zoom = d3.behavior.zoom()
			.scale(projection.scale() * 2 * Math.PI)
			// .scaleExtent([1 << 9, 1 << 25])
			.scaleExtent([1 << 11, 1 << 19])
			// .translate(projection([-73.978277, 40.6791989]).map(function(x) { return -x; }))
			.translate(projection([-70.1,-37.8]).map(function(x) { return -x; }))
			.on("zoom", zoomed);
			
	var container = d3.select("body").append("div")
			.attr("id", "container")
			.style("width", map_width + "px")
			.style("height", height + "px")
			.style("float", "left")
			.call(zoom);

	var map = container.append("g")
			.attr("id", "map")

	var points = container.append("svg")
			.attr("id", "points")

	var layer = map.append("div")
			.attr("class", "layer");

	var tip = d3.tip()
			.attr('class', 'd3-tip')
			.offset([-10, 0])
			.html(function(d) { 
				return filtros.zoom + ": "+ d.Nombre + 
					"<br/>Num Colegios: " + d.N_Colegios + 
					"<br/>Promedio Notas: " + round(d.Promedio_Notas,2) ;
			})





	d3.json('regiones.topojson', function(error, chile) {
		// console.log(topojson.feature(chile, chile.objects["chile-regions"]).features)


    d3.select("#points").selectAll("vector").data(topojson.feature(chile, chile.objects["chile-regions"]).features)
	    .enter()
	    .append("path")
	    .attr("d", tilePath)
	    .attr("class", "countries")
	    // .style("fill", "red")
	    .style("fill", function(d){
	    	// console.log(d.properties.Region)
	    	return color_regiones[d.properties.Region]
	    })
	    .style("stroke-width", 1)
	    .style("stroke", "black")
	    .style("fill-opacity", .5)
	});






	points.call(tip);
	zoomed();

	function createMap(dataset) {
		// if (init == 0){
		rangos = [min_promedio_nota]
		colors = []
		// console.log("rangos: ")
		for (var i = 1; i <= discretizacion; i++) {
			rango_nota = min_promedio_nota+((max_promedio_nota - min_promedio_nota)/discretizacion)*i
			color = get_discetized_color(rangos[i-1])
			// console.log("nota:",rangos[i-1],"\ncolor:", color)

			rangos.push(rango_nota)
			colors.push(color)
		}
		// console.log(rangos)
		write_legend(rangos, colors)

		d3.select("#points").selectAll("circle").data(dataset) //plotted 	locations on map
		.enter()
		.append("circle")
		.attr("cx", function(d) {return projection([d.Longitude,d.Latitude])[0]})
		.attr("cy", function(d) {return projection([d.Longitude,d.Latitude])[1]})
		.attr("class", "zona")
		.on('mouseover', tip.show)
		.on('mouseout', tip.hide)
		zoomed();
	}

	function clearMap(){
		d3.select("#points").selectAll("circle").remove();
		document.getElementById("my-legend").innerHTML = "";
	}

	function zoomed() {
		var tiles = tile
				.scale(zoom.scale())
				.translate(zoom.translate())
				();

		projection
				.scale(zoom.scale() / 2 / Math.PI)
				.translate(zoom.translate());

    d3.select("#points").selectAll("path")
    	.attr("d", geoPath);

		if (filtros.zoom_type == "Automatico"){
			if (zoom.scale() >= 49667){
				if (filtros.zoom == "Region") { //modificar a vista de comunas
					filtros.zoom = "Comuna"
					max_promedio_nota = max_nota["promedio_comuna"];
					min_promedio_nota = min_nota["promedio_comuna"];
					clearMap();
					createMap(data_comunas);
					clearCoordParalelas();
					createCoordParalelas(data_comunas);
				}
			}
			else {
				if (filtros.zoom == "Comuna") { //modificar a vista de regiones
					filtros.zoom = "Region"
					max_promedio_nota = max_nota["promedio_region"];
					min_promedio_nota = min_nota["promedio_region"];
					clearMap();
					createMap(data_regiones);
					clearCoordParalelas();
					createCoordParalelas(data_regiones);
				}
			}
		}

		var circles = d3.selectAll("circle")
				.attr("cx", function(d) {return projection([d.Longitude,d.Latitude])[0]})
				.attr("cy", function(d) {return projection([d.Longitude,d.Latitude])[1]})
				.attr("r", function(d) {
						// let escala = d.N_Colegios*.000001*zoom.scale();

					mult = 3 //significa que el mayor sera "mult" veces mas grande que el menor
					if (filtros.zoom == "Region") {
						// rescale = Math.log(d.N_Colegios)*.000001*zoom.scale();
						rescale = rescale_cant_colegios(d.N_Colegios, max_cant_colegios_region, min_cant_colegios_region, mult)
						let escala = rescale*.0005*zoom.scale();
						// return .0012*zoom.scale();
						return escala;
					}
					else if (filtros.zoom == "Comuna"){
						// rescale = (mult-1)/2900*d.N_Colegios + 1 - (mult-1)/29 //similar a usar escalamiento logaritmico pero con mayor control
						rescale = rescale_cant_colegios(d.N_Colegios, max_cant_colegios_comuna, min_cant_colegios_comuna, mult)
						let escala = rescale*.000025*zoom.scale();
						return escala;
					}
				})
				
				.attr("fill", function(d) { //coloreo
					// f(x) = ax + b
					// a_bueno = 255/(max_promedio_nota-min_promedio_nota)
					// b_bueno = -a_bueno*min_promedio_nota
					// bueno = a_bueno*d.Promedio_Notas+b_bueno

					// a_malo = 255/(min_promedio_nota-max_promedio_nota)
					// b_malo = -a_malo*max_promedio_nota
					// malo = a_malo*d.Promedio_Notas+b_malo

					return get_discetized_color(d.Promedio_Notas)
				})
				.attr("stroke", "black");

		var image = layer
				.style(prefix + "transform", matrix3d(tiles.scale, tiles.translate))
				.selectAll(".tile")
				.data(tiles, function(d) { return d; });

		image.exit()
				.remove();

		image.enter().append("img")
				.attr("class", "tile")
				.attr("src", function(d) { return "http://" + "abc"[d[1] % 3] + ".tile.openstreetmap.org/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
				// .attr("src", function(d) { return "http://" + ["a", "b", "c"][Math.random() * 3 | 0] + ".tile.openstreetmap.se/hydda/full/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
				.style("left", function(d) { return (d[0] << 8) + "px"; })
				.style("top", function(d) { return (d[1] << 8) + "px"; });
	}
	
	function write_legend(ranges, colors){
		html_to_write = "\
		<div id='legend-title'>Nota promedio</div>\
		<div id='legend-scale'>\
			<ul id='legend-labels'>"

				for (var i = 0; i < colors.length; i++) {
					// console.log(ranges[i+1])
					hex_color = rgbToHex(colors[i].r, colors[i].g, colors[i].b)
					if (i == 0){
						// html_to_write += "<li><span style='background:"+hex_color+";'></span>"+round(ranges[0],2).toString()+" - "+round(ranges[i+1],2).toString()+"</li>"
						html_to_write += "<li><span style='background:"+hex_color+";'></span><span style='right: 9px; position: relative; width: auto;'>"+round(ranges[0],2).toString()+"</span><span style='right: -18px; position: relative; width: auto;'>"+round(ranges[i+1],2).toString()+"</span></li>"
					}
					else{
						html_to_write += "<li><span style='background:"+hex_color+";'></span><span style='right: -10px; position: relative;'>"+round(ranges[i+1],2).toString()+"</span></li>"
					}
				}
			html_to_write += "</ul>\
		</div>";

		document.getElementById("my-legend").innerHTML = html_to_write;
	}

	function matrix3d(scale, translate) {
		var k = scale / 256, r = scale % 1 ? Number : Math.round;
		return "matrix3d(" + [k, 0, 0, 0, 0, k, 0, 0, 0, 0, k, 0, r(translate[0] * scale), r(translate[1] * scale), 0, 1 ] + ")";
	}

	function prefixMatch(p) {
		var i = -1, n = p.length, s = document.body.style;
		while (++i < n) if (p[i] + "Transform" in s) return "-" + p[i].toLowerCase() + "-";
		return "";
	}

	function formatLocation(p, k) {
		var format = d3.format("." + Math.floor(Math.log(k) / 2 - 2) + "f");
		return (p[1] < 0 ? format(-p[1]) + "°S" : format(p[1]) + "°N") + " "
				 + (p[0] < 0 ? format(-p[0]) + "°W" : format(p[0]) + "°E");
	}


///////////////////////////////////////////////////////
//          INICIALIZACION CANVAS DE COORD PARALELAS
///////////////////////////////////////////////////////
	var tooltip = d3.select("body")
		.append("div")
		.style("position", "absolute")
		.style("z-index", "10")
		.style("visibility", "hidden")
		.text("a simple tooltip")
		.attr("class","tooltip");

	var margin = {
		top: 30, 
		right: 10, 
		bottom: 10, 
		left: 10
	},
	c_width = coord_width - margin.left - margin.right,
	c_height = coord_height - margin.top - margin.bottom;

	// d3.csv("data5.csv", function(error, region) {
		// Extract the list of dimensions and create a scale for each.
		// createCoordParalelas(region)
	// });
		var x = d3.scale.ordinal().rangePoints([0, c_width], 1),
				y = {},
				dragging = {};

		var line = d3.svg.line(),
				axis = d3.svg.axis().orient("left"),
				background,
				foreground,
				svg;


	function createCoordParalelas(dataset){

		svg = d3.select("body").append("svg")
			.attr("id", "coordenadas_paralelas")
			.attr("width", c_width + margin.left + margin.right)
			.attr("height", c_height + margin.top + margin.bottom)
			.attr("style", "float: right;")
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		// let notas_done = false
		x.domain(dimensions = d3.keys(dataset[0]).filter(function(d) {
				return (d != "Nombre" && d != "Longitude" && d != "Latitude" && d != "Region") && (y[d] = d3.scale.linear()
					.domain(d3.extent(dataset, function(p) { 

						return +p[d]; 
					}))
					.range([c_height, 0]));
		}));

		// usar los mismos dominios para las cordenadas de las notas
		for (var i = 0; i < d3.keys(dataset[0]).length; i++) {
			dominio = d3.keys(dataset[0])[i]
			if (dominio == "Promedio_Notas" || dominio == "Promedio_Mujeres" || dominio == "Promedio_Hombres"){
				if (filtros.zoom == "Region"){
					y[dominio].domain([min_nota["total_region"], max_nota["total_region"]])
				}
				else{
					y[dominio].domain([min_nota["total_comuna"], max_nota["total_comuna"]])
				}
			}
		}


		// Add grey background lines for context.
		background = svg.append("g")
			.attr("class", "background")
			.selectAll("path")
			.data(dataset)
			.enter().append("path")
			.attr("d", path);

		// Add blue foreground lines for focus.
		foreground = svg.append("g")
			.attr("class", "foreground")
			.selectAll("path")
			.data(dataset)
			.enter().append("path")
			.attr("d", path)
			.attr("style", function(d){
				if ("Region" in d){
					return "stroke: "+color_regiones[d.Region]
				}
				else{ //si esta en la vista de regiones
					return "stroke: "+color_regiones[d.Nombre]
				}
			})
			.on("mouseover", function(n){
				d3.select(this).transition().duration(100)
				.style({'stroke' : '#F00'});
				tooltip.text(n.Nombre);
				return tooltip.style("visibility", "visible");
			})
			.on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
			.on("mouseout", function(d){
				d3.select(this).transition().duration(100)
				.attr("style", function(n){
					if ("Region" in d){
						color = "stroke: "+color_regiones[d.Region]
						return color
					}
					else{ //si esta en la vista de regiones
						// console.log(d)
						color = "stroke: "+color_regiones[d.Nombre]
						return color
					}
				})
				// .style({'stroke-width' : '2'});
				return tooltip.style("visibility", "hidden");
			});

		// Add a group element for each dimension.
		var g = svg.selectAll(".dimension")
		.data(dimensions)
			.enter().append("g")
			.attr("class", "dimension")
			.attr("transform", function(d) { 
				return "translate(" + x(d) + ")"; 
			})
			.call(d3.behavior.drag()
				.origin(function(d) { 
					return {x: x(d)
					};
				})
				.on("dragstart", function(d) {
					dragging[d] = x(d);
					background.attr("visibility", "hidden");
				})
				.on("drag", function(d) {
					dragging[d] = Math.min(width, Math.max(0, d3.event.x));
					foreground.attr("d", path);
					dimensions.sort(function(a, b) {
						return position(a) - position(b);
					});
					x.domain(dimensions);
					g.attr("transform", function(d) { 
						return "translate(" + position(d) + ")";
					})
				})
				.on("dragend", function(d) {
					delete dragging[d];
					transition(d3.select(this))
						.attr("transform", "translate(" + x(d) + ")");
					transition(foreground).attr("d", path);
					background
						.attr("d", path)
						.transition()
						.delay(500)
						.duration(0)
						.attr("visibility", null);
				})
			);

		// Add an axis and title.
		g.append("g")
			.attr("class", "axis")
			.each(function(d) {
				d3.select(this).call(axis.scale(y[d]));
			})
			.append("text")
			.style("text-anchor", "middle")
			.attr("y", -9)
			.text(function(d) {
				return d;
			});

		// Add and store a brush for each axis.
		g.append("g")
			.attr("class", "brush")
			.each(function(d) {
				d3.select(this).call(y[d].brush = d3.svg.brush().y(y[d]).on("brushstart", brushstart).on("brush", brush));
			})
			.selectAll("rect")
			.attr("x", -8)
			.attr("width", 16);
	}

	function clearCoordParalelas(){
		// svg.remove();
		document.getElementById("coordenadas_paralelas").remove();
	}

	function position(d) {
		var v = dragging[d];
		return v == null ? x(d) : v;
	}

	function transition(g) {
		return g.transition().duration(500);
	}

	// Returns the path for a given data point.
	function path(d) {
		return line(dimensions.map(function(p){
			return [position(p), y[p](d[p])]; 
		}));
	}

	function brushstart() {
		d3.event.sourceEvent.stopPropagation();
	}

	// Handles a brush event, toggling the display of foreground lines.
	function brush() {
		var actives = dimensions.filter(function(p) { 
			return !y[p].brush.empty(); 
		}),
		extents = actives.map(function(p) { 
			return y[p].brush.extent(); 
		});
		foreground.style("display", function(d) {
			return actives.every(function(p, i) {
				return extents[i][0] <= d[p] && d[p] <= extents[i][1];
			}) ? null : "none";
		});
	}

</script>

<div id='my-legend'>
</div>

</body>
</html>